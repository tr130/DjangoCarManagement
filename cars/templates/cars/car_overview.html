{% extends 'cars/base.html' %}

{% load crispy_forms_tags %}

{% block content %}
<h1>Car overview</h1>
<h3>{{ car.model_name }}</h3>
<h4>{{ car.year }}</h4>

<div class="row">
  <div class="list-group col-8">
    <h3>Jobs</h3>
    {% if request.session.role == 'Manager' %}
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
  Add job
</button>
{% endif %}
    {% for job in car.job_set.all %}
    <a href="{% url 'cars:job-details' job.id %}" class="list-group-item list-group-item-action">
      <div class="d-flex w-100 justify-content-between">
        <div>
          <h5 class="mb-1 d-inline">{{ job.title }}</h5>
          {% if job.complete %}
          <span class="badge rounded-pill bg-success">Complete</span>
            {% if job.paid %}
              <span class="badge rounded-pill bg-success">Paid</span>
            {% else %}
              <span class="badge rounded-pill bg-danger">Unpaid</span>
            {% endif %}
          {% elif job.in_progress %}
          <span class="badge rounded-pill bg-warning text-dark">In Progress</span>
          {% else %}
          <span class="badge rounded-pill bg-danger">Not Started</span>
          {% endif %}
        </div>
        <small>{{ job.created }}</small>
      </div>
      <p class="mb-1">{{ job.description|truncatewords:6 }}</p>
      <div class="d-flex w-100 justify-content-between">
        <small>Assigned to: {{ job.employee }}</small>
        <small>Expected by: {{ job.expected_complete }}</small>
      </div>
    </a>
    {% endfor %}
  </div>
  <div class="col-4">
    <div class="list-group">
      <h3>Messages</h3>
      <div class="btn-group">
        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          New message
        </button>
        <form action="{% url 'cars:send-message' %}" method="post" class="dropdown-menu p-4">
      {% csrf_token %}
      {{ message_form|crispy }}
      <input type="hidden" name="form_type" value="message">
      <button type="submit" class="btn btn-primary">Add message</button>
    </form>
      </div>
      
      {% for message in messages %}
      <div class="list-group-item list-group-item-action">
        <div class="d-flex w-100 justify-content-between">
          <div>
            {% if message.job %}
            <h5><a href="{% url 'cars:job-details' message.job.id %}" class="mb-1 d-inline">{{ message.job }}</a></h5>
            {% else %}
            <h5 class="mb-1 d-inline">{{ message.subject }}</h5>
            {% endif %}
          </div>
          <small>{{ message.created }}</small>
        </div>
        <p class="mb-1">{{ message.body }}</p>
        {% if request.session.role == 'Manager' and not message.job %}
          <form action="{% url 'cars:assign-message-to-job' %}" method="POST">
          {% csrf_token %}
          <input type="hidden" name="message_id" value="{{ message.id }}">
          <select name="job_id" id="job_id">
            <option name="job_id" value="" disabled selected>Assign to Job</option>
            {% for job in car.job_set.all %}
              <option name="job_id" value="{{ job.id }}">{{ job }}</option>
            {% endfor %}
          </select>
          <button class="btn-secondary btn-sm">Assign to Job</button>
          </form>
          
        {% endif %}
        <div class="d-flex w-100 justify-content-between align-items-center">
          <small>From: {{ message.sender }}</small>
          <small>To: {{ message.recipient }}</small>
          {% if message.unread %}
            <span class="badge rounded-pill bg-danger">Unread</span>
          {% else %}
            <span class="badge rounded-pill bg-success">Read</span>
          {% endif %}
        </div>
        {% if request.user == message.recipient and message.unread %}
          <form action="{% url 'cars:message-read' %}" method="POST">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="message_read">
          <input type="hidden" name="message_id" value="{{ message.id }}">
          <button class="btn-primary btn-sm">Mark as read.</button>
          </form>
          
        {% endif %}
        
      </div>
      {% endfor %}
    </div>
  </div>
</div>




<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Add job</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="" id="job-form" method="post">
          {% csrf_token %}
          {{ job_form|crispy }}
          <input type="hidden" name="form_type" value="job">
          <button type="submit" class="btn btn-info mt-2">Save</button>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% endblock content %}